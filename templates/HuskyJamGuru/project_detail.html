{% extends 'base.html' %}
{% load settings_value %}

{% block content %}

    <div style="display: none;" id="panel-for-copying">
        <div class="panel panel-success">
            <div class="panel-heading"><a href="#" class="issue-name"></a>
                (<small class="issue-heading-time"></small>)
            </div>
            <div class="panel-body">
                <small class="issue-body"></small>
            </div>
        </div>
    </div>


    <div class="bs-docs-section">
        <div class="row">
            <div class="col-lg-3">
                <h2>Open</h2>
            </div>
            <div class="col-lg-3">
                <h2>In Progress</h2>
            </div>
            <div class="col-lg-3">
                <h2>Fixed</h2>
            </div>
            <div class="col-lg-3">
                <h2>Verified</h2>
            </div>
        </div>
        <div class="row">
            {% for gitlab_project in project.gitlab_projects.all %}
                {{ gitlab_project.name }} <br><br>
                {% for milestone in gitlab_project.gitlab_milestones.all %}
                    <div class="panel panel-default">
                        <div class="panel-heading"><a target="_blank" href ="{% settings_value "GITLAB_URL" %}/root/{{ gitlab_project.name }}/milestones/{{ milestone.gitlab_milestone_id }}"> {{ milestone.name }}</a> <small class="pull-right"></small></div>
                        <div class="panel-body milestone" milestone-id="{{ milestone.pk }}">
                            <div class="col-lg-3 drop-row">
                                <div class="col-lg-12 dropable open-row">
                                </div>
                            </div>
                            <div class="col-lg-3 drop-row">
                                <div class="col-lg-12 dropable in_progress-row">
                                </div>
                            </div>
                            <div class="col-lg-3 drop-row">
                                <div class="col-lg-12 dropable fixed-row">
                                </div>
                            </div>
                            <div class="col-lg-3 drop-row">
                                <div class="col-lg-12 dropable verified-row">
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <script>
        $(document).ready(function() {
            updateTaskPositions();
        });

        var updateIssueType = function(issuePk, newType){
            $.ajax({
                url: "/api/v1/IssueTypeUpdate/",
                type: "POST",
                data:{
                    type: newType,
                    gitlab_issue: issuePk
                }
            }).done(function( result ) {
                console.log(result);
            });
        };

        $(function() {
            $('.dropable').sortable({
                connectWith: ".dropable",
                revert: true,
                cursor: 'move',
                activeClass: "ui-state-hover",
                receive: function(event, ui){
                    var newType = 'open';
                    if($(event.target).hasClass("in_progress-row")){
                        newType = 'in_progress';
                    }
                    if($(event.target).hasClass("fixed-row")){
                        newType = 'fixed';
                    }
                    if($(event.target).hasClass("verified-row")){
                        newType = 'verified';
                    }
                    $(ui.item[0]).attr('issue-pk');
                    updateIssueType($(ui.item[0]).attr('issue-pk'), newType)
                }
            });
        });

        function updateTaskPositions() {
            $.ajax({
                url: "/api/v1/GitLabIssue/?project_pk={{ project.pk }}"
            }).done(function( issues ) {
                for (var i = 0; i < issues.length; i++){
                    if (issues[i].current_type == null){
                        issues[i].current_type = 'open';
                    }
                    var targetPlaceForPanel = $("[milestone-id='" + issues[i].gitlab_milestone + "']").find("." + issues[i].current_type.type + "-row");
                    var existPanel = $("[issue-pk=" + issues[i].pk + "]");
                    var panel = null;
                    if(targetPlaceForPanel.has(existPanel).length){
                        panel = existPanel;
                    } else {
                        existPanel.remove();
                        panel = $("#panel-for-copying").children().clone();
                        panel.appendTo(targetPlaceForPanel);
                    }
                    panel.find(".issue-name").text(issues[i].name);
                    ///root/Super5-server/issues/1
                    panel.find(".issue-name").attr("href", issues[i].link);
                    panel.find(".issue-body").text(issues[i].description);
                    panel.find(".issue-heading-time").text(issues[i].spent_minutes + ' minutes');
                    panel.attr('issue-pk', issues[i].pk);
                }
            });
            setTimeout(updateTaskPositions, 5000);
        }
    </script>
{% endblock %}